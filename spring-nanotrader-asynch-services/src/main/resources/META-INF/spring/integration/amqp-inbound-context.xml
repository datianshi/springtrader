<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:int-amqp="http://www.springframework.org/schema/integration/amqp"
	xmlns:int="http://www.springframework.org/schema/integration"
	xsi:schemaLocation="http://www.springframework.org/schema/integration/amqp http://www.springframework.org/schema/integration/amqp/spring-integration-amqp.xsd
		http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration.xsd
		http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">

	<import resource="amqp-common-context.xml" />

<!--#################################################################### 
	Order Processing:
	a) Receives the order
	b) Creates an order record (inside the service activator)
	c) Creates a holding
	d) Updates the account balance
	c) Publishes a quote with an updated price
	#################################################################### -->
	
	<int-amqp:inbound-channel-adapter
		mapped-request-headers="uniqueId" channel="toTradingServiceChannel"
		message-converter="jsonConverter" queue-names="nanotrader.order.queue"
		connection-factory="connectionFactory" />

	<int:channel id="toTradingServiceChannel">
		<int:interceptors>
			<int:wire-tap channel="toGeneralloggingChannel" />
		</int:interceptors>
	</int:channel>

	<int:service-activator input-channel="toTradingServiceChannel"
		output-channel="nullChannel" ref="tradingServiceFacadeImpl" method="saveOrderDirect">
		<int:request-handler-advice-chain>
			<ref bean="retryAdvice" />
		</int:request-handler-advice-chain>
	</int:service-activator>


<!--#################################################################### 
	Quote Processing: Receive it, Update it and log it to file
	#################################################################### -->

	<int-amqp:inbound-channel-adapter
		channel="toTradingServiceQuoteChannel" message-converter="jsonConverter"
		queue-names="nanotrader.quote.queue" connection-factory="connectionFactory" />
	
	<int:channel id="toTradingServiceQuoteChannel">
		<int:interceptors>
			<int:wire-tap channel="toGeneralloggingChannel" />
		</int:interceptors>
	</int:channel>

	<int:service-activator input-channel="toTradingServiceQuoteChannel"
		output-channel="nullChannel" ref="tradingServiceImpl" method="updateQuote">
		<int:request-handler-advice-chain>
			<ref bean="retryAdvice" />
		</int:request-handler-advice-chain>
	</int:service-activator>
	

<!--#################################################################### 
	Retry Handling: 
	#################################################################### -->
	
	<bean id="retryAdvice" class="org.springframework.integration.handler.advice.RequestHandlerRetryAdvice">
		<property name="retryStateGenerator">
			<bean class="org.springframework.integration.handler.advice.SpelExpressionRetryStateGenerator">
				<constructor-arg value="headers['uniqueId']" />
			</bean>
		</property>
		<property name="recoveryCallback">
			<bean class="org.springframework.integration.handler.advice.ErrorMessageSendingRecoverer">
				<constructor-arg ref="toRecoveryHandlerChannel" />
			</bean>
		</property>
	</bean>

	<int:channel id="toRecoveryHandlerChannel" />
	
	<int:chain input-channel="failedChannel">
		<int:transformer expression="'Retries exceeded: permanently failed:' + payload.failedMessage.payload + ' handled by recovery'" />
		<int:logging-channel-adapter
			logger-name="org.springframework.nanotrader.asynch.generalLogger"
			level="DEBUG" />
	</int:chain>
	
<!--#################################################################### 
	General Logging: 
	#################################################################### -->
		
	<int:channel id="toGeneralloggingChannel" />

	<int:logging-channel-adapter
		logger-name="org.springframework.nanotrader.asynch.generalLogger"
		channel="toGeneralloggingChannel" expression="'Received Payload: ' + payload " level="INFO" />
		
</beans>
